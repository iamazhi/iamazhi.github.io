(window.webpackJsonp=window.webpackJsonp||[]).push([["dx_Yon"],{dx_ELL6:function(e,o,n){"use strict";n.r(o),n.d(o,"CommentModuleBase",(function(){return _e}));var r,i=n("dx_o0o1"),a=n.n(i),c=n("dx_yXPU"),m=n.n(c),l=n("dx_lSNA"),d=n.n(l),s=n("dx_lwsE"),u=n.n(s),h=n("dx_W8MJ"),v=n.n(h),f=n("dx_PJYZ"),p=n.n(f),g=n("dx_W7W2"),C=n.n(g),y=n("dx_a1gu"),k=n.n(y),I=n("dx_Nsbk"),b=n.n(I),M=n("dx_QxNg"),T=n("dx_UtDZ"),B=n("dx_h6a8"),O=n("dx_FvGq"),E=n("dx_ey54"),R=n("dx_k8kI"),P=n("dx_J4zp"),w=n.n(P),x=n("dx_RIqP"),S=n.n(x),A=n("dx_GSgQ"),j=n("dx_yzqx"),_=n("dx_ahlY"),D=n("dx_b3bq"),N=n("dx_B28d"),L=n("dx_WXfY"),H=n("dx_ZG9w"),U=n("dx_acOG"),V=n("dx_j6ji"),K=n("dx_EqZO"),z=n("dx_zghO"),G=n("dx_UhQm"),q=n("dx_D8nn"),F=n("dx_qx8A"),Q=n.n(F),W=n("dx_Fimk"),Y=n("dx_CwnG"),J=n("dx_iWIM"),Z=n.n(J),X=n("dx_rQGm"),ee=n("dx_wDsH"),te=n("dx_b28D"),oe=n("dx_S0Si"),ne=n("dx_QBqw"),re=Object(te.e)("comment:scroller");!function(e){e[e.Upward=0]="Upward",e[e.Viewport=1]="Viewport",e[e.MinimizeScroll=2]="MinimizeScroll"}(r||(r={}));var ie=function(){function e(o,n,i,a){var c=this;u()(this,e),this.commentModule=o,this.blockManager=n,this.viewport=i,this.scrollerElement=a,this.strategy=void 0,this.calcScrollTop=function(e){var o=e.top,n=e.bottom,i=e.viewportHeight,a=e.panelTop,m=e.overrideStrategy,l=e.gap,d=e.scrollY,s=void 0===d?c.scrollTop:d;if(void 0!==a)return o-a;var u=null!==m&&void 0!==m?m:c.strategy;return u===r.MinimizeScroll?s+i-o<92?o-i+92:o-l<s?o-l:s:(n+=l)-(o-=l)>i||o<s?o:n>s+i?u===r.Viewport?n-i:o:s}}return v()(e,[{key:"getCommentPositionInfo",value:function(e,o){var n=this.commentModule.getPositionByCommentId(e);if(n){var r=n.top,i=n.height,a=r+Object(_.y)();return{top:a,bottom:a+i,viewportHeight:o||0,gap:0}}}},{key:"fixHorizontalScroll",value:function(e){var o=this.commentModule.getBlockModelsByCommentId(e),n=this.commentModule.getCommentRect(e);o.length&&(re("fixHorizontalScroll: commentId=%s, blockId=%s, position=%o",e,o[0].id,n),Object(ne.q)(this.blockManager,o[0].id,n,oe.L.COMMENT_SCROLL))}},{key:"scrollToComment",value:function(){var e=m()(a.a.mark((function e(o,n,i){var c,m,l,d,s,u,h,v,f,p,g,C,y,k,I=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(m=this.commentModule.getPositionByCommentId(o)){e.next=3;break}return e.abrupt("return");case 3:if(re("%s.scrollToComment: %s",n,o),l=this.scrollTop,d=m.blockId,this.viewport.isBlockInViewport(d)||this.blockManager.rootBlockId===d){e.next=11;break}return e.next=10,this.viewport.scrollToBlock(d,void 0,!0);case 10:this.commentModule.calcCommentPositionByBlockId(d);case 11:if(s=this.getCommentPositionInfo(o,null===i||void 0===i?void 0:i.innerHeight)){e.next=14;break}return e.abrupt("return");case 14:if(u=s.top,h=s.bottom,v=s.viewportHeight,f=s.gap,p=null!==(c=null===i||void 0===i?void 0:i.overrideStrategy)&&void 0!==c?c:this.strategy,g=p===r.MinimizeScroll,C=Math.max(0,this.calcScrollTop({top:u,bottom:h,viewportHeight:v,gap:f,panelTop:null===i||void 0===i?void 0:i.panelTop,overrideStrategy:null===i||void 0===i?void 0:i.overrideStrategy,scrollY:l})),!(Math.abs(C-this.scrollTop)<.5)){e.next=22;break}return e.abrupt("return",this.fixHorizontalScroll(o));case 22:return null===i||void 0===i||null===(y=i.beforeScroll)||void 0===y||y.call(i),null===(k=this.commentModule.vcPosition)||void 0===k||k.disableNextSendPosition(),e.abrupt("return",new Promise((function(e){I.waitToScroll(C,(function(){I.fixHorizontalScroll(o),e()}),g)})));case 25:case"end":return e.stop()}}),e,this)})));return function(o,n,r){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){}}]),e}();function ae(e){var o=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=b()(e);if(o){var i=b()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return k()(this,n)}}var ce=function(e){C()(n,e);var o=ae(n);function n(){var e,i;u()(this,n);for(var a=arguments.length,c=new Array(a),m=0;m<a;m++)c[m]=arguments[m];return(i=o.call.apply(o,[this].concat(c))).strategy=r.Upward,i.getCommentPositionInfo=function(o,r){var a=Z()((e=p()(i),b()(n.prototype)),"getCommentPositionInfo",e).call(e,o,r);return a?{top:a.top,bottom:a.bottom,viewportHeight:a.viewportHeight||i.scrollerClientHeight,gap:90}:a},i}return v()(n,[{key:"waitToScroll",value:function(e,o){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];n?Object(ee.p)(this.scroller.get(0),e,!0,o,o):(this.scroller.stop(),this.scroller.scrollTop(e),null===o||void 0===o||o())}},{key:"scrollToBottom",value:function(){}},{key:"scroller",get:function(){return this.scrollerElement?$(this.scrollerElement):$(".".concat(X.b3.ROOT))}},{key:"scrollTop",get:function(){return this.scroller.scrollTop()||0}},{key:"scrollerClientHeight",get:function(){return this.scroller.height()||0}}]),n}(ie),me=ce,le=n("dx_eGDr"),de=n("dx_e4eN"),se=n("dx_M30o"),ue=n("dx_vdIl"),he=n("dx_Z7ZC"),ve=n("dx_AMht"),fe=n("dx_eSV8"),pe=n("dx_bPy9"),ge=n("dx_kZ3l"),Ce=n("dx_upU1"),ye=function(){function e(o){var n=o.blockManager,r=o.eventCollector;u()(this,e),this.blockManager=void 0,this.eventCollector=void 0,this.generateEasysyncCs=function(e,o,n,r){var i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=r.record,c=new de.m({zoneId:ue.x});c.retain(o[0]),c.retain(o[1]-o[0],d()({},Object(Ce.i)(n),i?"":"true"));var m=new se.q(d()({},ue.x,c)),l=e.getModelText();l=l.substr(0,l.length-1);var s=r.snapshot.text.initialAttributedTexts.text[ue.x];(r.translateStatus||Object(he.a)(s))&&(l=s);var u=d()({},ue.x,l);return Object(he.i)(m,a,{apool:{numToAttrib:{0:[Object(Ce.i)(n),i?"":"true"]},nextNum:1},zone_changesets:u})},this.blockManager=n,this.eventCollector=r}return v()(e,[{key:"addLocalCommentMark",value:function(e,o,n,r){var i=this.eventCollector,a=i.collectEvent,c=i.getBlockViewByBlockId,m=this.blockManager.getBlockModelByBlockId(o),l=this.blockManager.getBlockViewByBlockIdNotCheck(o),s=m.zoneState.totalWidth(),u=d()({},Object(Ce.y)(e),"true");l&&l.editor.setStopUpdateSelection(!0);try{m.setAttributes(Object(ge.JI)(m.zoneState,n),u,{extra:{shouldCollab:!1}})}catch(h){Object(fe.n)(h)}setTimeout((function(){l&&l.editor.setStopUpdateSelection(!1)}),0),a(le.l.addLocalCommentMark,{targetBlock:c(o),commentId:e,range:n,blockTextLength:s},r)}},{key:"innerRemoveTextLocalCommentMark",value:function(e,o){var n=null;if(n=e.translateStatus?[0,e.snapshot.text.initialAttributedTexts.text[ue.x].length]:Object(Ce.l)(e,o,!0)){var r=d()({},Object(Ce.y)(o),"");e.setAttributes(Object(ge.JI)(e.zoneState,n),r,{extra:{shouldCollab:!1}})}return n}},{key:"removeLocalCommentMark",value:function(e,o){var n=this.eventCollector,r=n.collectEvent,i=n.getBlockViewByBlockId,a=this.blockManager.getBlockModelByBlockId(o);this.innerRemoveTextLocalCommentMark(a,e),r(le.l.removeLocalCommentMark,{targetBlock:i(o),commentId:e})}},{key:"applyAddTextComment",value:function(e,o,n,r){var i=this;n.forEach((function(n){var a=i.blockManager.getBlockIdsByRecordId(n),c=i.blockManager.getRecord(n),m=null;if(a.forEach((function(o){var n=i.blockManager.getBlockModelByBlockId(o),r=i.innerRemoveTextLocalCommentMark(n,e);r&&(m=r)})),console.info("[CommentModule] recordRange",n,o,m),m){var l=i.blockManager.getBlockModelByBlockId(a[0]),s=l.zoneState;if(ve.S.lineEditable){var u=i.generateEasysyncCs(s,m,o,l);r.edit(n,["text"],u)}else{var h=i.blockManager.getBlockModelByBlockId(a[0]),v=h.zoneState,f=Object(pe.o)(h.record.snapshot.text,Object(ge.JI)(v,m),d()({},Object(Ce.i)(o),"true"));r.replace(n,["text"],f)}c.snapshot.comments?r.insert(n,["comments",0],o):r.replace(n,["comments"],[o])}}))}},{key:"applyDeleteTextComment",value:function(e,o,n){var r=this;o.forEach((function(o){var i=r.getCommentIndex(e,o);if(-1!==i){var a=r.blockManager.getBlockIdsByRecordId(o),c=r.blockManager.getBlockModelByBlockId(a[0]),m=c.translateStatus?Object(Ce.a)(c,e):Object(Ce.l)(c,e),l=c.zoneState;if(m)if(ve.S.lineEditable){var s=r.generateEasysyncCs(l,m,e,c,!0);n.edit(o,["text"],s)}else{var u=c.zoneState,h=Object(pe.o)(c.record.snapshot.text,Object(ge.JI)(u,m),d()({},Object(Ce.i)(e),""));n.replace(o,["text"],h)}n.remove(o,["comments",i])}}))}},{key:"applyAddBlockComment",value:function(e,o,n){var r=this;o.forEach((function(o){!!r.blockManager.getRecord(o).snapshot.comments?n.insert(o,["comments",0],e):n.replace(o,["comments"],[e])}))}},{key:"applyDeleteBlockComment",value:function(e,o,n){var r=this;o.forEach((function(o){var i=r.getCommentIndex(e,o);-1!==i&&n.remove(o,["comments",i])}))}},{key:"splitRecord",value:function(e){var o=this;return e.reduce((function(e,n){var r=o.blockManager.getBlockIdsByRecordId(n),i=o.blockManager.getBlockViewByBlockId(r[0]);return Object(H.f)(i)?e.textual.push(n):e.nonTextual.push(n),e}),{textual:[],nonTextual:[]})}},{key:"getCommentIndex",value:function(e,o){var n;return(n=this.blockManager.getRecord(o).snapshot)&&n.comments?n.comments.indexOf(e):-1}}]),e}(),ke=n("dx_Ayao"),Ie=n("dx_l6la"),be=function(){function e(){u()(this,e),this.hideNumberTimer=null}return v()(e,[{key:"destroy",value:function(){this.clearHideNumberTimer()}},{key:"temporaryHideNumbers",value:function(){this.clearHideNumberTimer(),T.store.dispatch(Object(Ie.Y5)(!1))}},{key:"showNumbers",value:function(){this.clearHideNumberTimer(),this.hideNumberTimer=window.setTimeout((function(){T.store.dispatch(Object(Ie.Y5)(!0))}),600)}},{key:"clearHideNumberTimer",value:function(){this.hideNumberTimer&&window.clearTimeout(this.hideNumberTimer)}}]),e}();function Me(e,o){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,o){if(!e)return;if("string"===typeof e)return Te(e,o);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Te(e,o)}(e))||o&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,c=!0,m=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return c=e.done,e},e:function(e){m=!0,a=e},f:function(){try{c||null==n.return||n.return()}finally{if(m)throw a}}}}function Te(e,o){(null==o||o>e.length)&&(o=e.length);for(var n=0,r=new Array(o);n<o;n++)r[n]=e[n];return r}function Be(e,o){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);o&&(r=r.filter((function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable}))),n.push.apply(n,r)}return n}function Oe(e){for(var o=1;o<arguments.length;o++){var n=null!=arguments[o]?arguments[o]:{};o%2?Be(Object(n),!0).forEach((function(o){d()(e,o,n[o])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Be(Object(n)).forEach((function(o){Object.defineProperty(e,o,Object.getOwnPropertyDescriptor(n,o))}))}return e}var Ee=function(){function e(o,n,r,i,a){var c=this;u()(this,e),this.rect=o,this.fold=n,this.blockManager=r,this.commentModule=i,this.eventColletor=a,this.loadedThirdParty=new Set,this.thirdPartyCommentMap=new Map,this.handleHoverCommentChange=function(e){var o=e.hoverCommentId,n=e.prevHoverCommentId;n&&c.removeHoverHighlight(n),o&&c.addHoverHighlight(o)},this.handleActivateCommentChange=function(e){var o=e.prevActiveCommentId,n=e.activeCommentId;o&&(c.removeHoverHighlight(o),c.deactivateComment(o)),n&&c.activateComment(n)},this.commentModule.on(ke.M.HOVER_COMMENT_CHANGE,this.handleHoverCommentChange),this.commentModule.on(ke.M.ACTIVE_COMMENT_CHANGE,this.handleActivateCommentChange)}return v()(e,[{key:"destroy",value:function(){this.commentModule.off(ke.M.HOVER_COMMENT_CHANGE,this.handleHoverCommentChange),this.commentModule.off(ke.M.HOVER_COMMENT_CHANGE,this.handleActivateCommentChange)}},{key:"getBlockModel",value:function(e){return this.blockManager.getBlockModelByBlockId(e)}},{key:"getRecordIdByCommentId",value:function(e){var o=this,n=this.commentModule.getCommentByCommentId(e);if(n){var r=n.parentType,i=n.parentToken;if(r&&i)return S()(this.loadedThirdParty).find((function(e){var n=o.blockManager.getBlockIdsByRecordId(e)[0],a=o.getBlockModel(n);return a.isThirdPartyCommentBlock&&a.serviceType===r&&a.serviceToken===i}))}}},{key:"combineCommentRect",value:function(e,o,n,r){var i,a=this.getCommentRelativeTop(n,e),c=null!==(i=n.thirdPartyHeight)&&void 0!==i?i:0,m=r?a:0,l=r?a+c:0;return Oe(Oe({},o),{},{top:o.top+m,height:c,bottom:o.top+l,visible:r,blockId:e})}},{key:"getBlocksByCommentId",value:function(e){var o=this,n=this.getRecordIdByCommentId(e);return n?this.blockManager.getBlockIdsByRecordId(n).map((function(e){return o.getBlockModel(e)})):[]}},{key:"isThirdPartyBlock",value:function(e){var o=this.blockManager.getBlockModelByBlockIdNotCheck(e);return!!o&&!!o.isThirdPartyCommentBlock}},{key:"isThirdPartyRecord",value:function(e){var o=this.blockManager.getBlockIdsByRecordId(e)[0];return this.isThirdPartyBlock(o)}},{key:"isThirdPartyTypeComment",value:function(e){var o=this.commentModule.getCommentByCommentId(e);return!!o&&!!o.parentToken&&!!o.parentType}},{key:"isThirdPartyComment",value:function(e,o){if(o){var n=this.commentModule.getCommentByCommentId(e),r=this.blockManager.getBlockIdsByRecordId(o)[0],i=r?this.getBlockModel(r):null;if(n&&(null===i||void 0===i?void 0:i.isThirdPartyCommentBlock))return!!n.parentType&&n.parentType===i.serviceType}return!!this.getRecordIdByCommentId(e)}},{key:"isLoaded",value:function(e){return!this.isThirdPartyRecord(e)||this.loadedThirdParty.has(e)}},{key:"handleLoaded",value:function(e){var o=this.eventColletor,n=o.collectEvent,r=o.getBlockViewByRecordId;this.loadedThirdParty.add(e),this.setCommentData(e,this.commentModule.getCommentData()),n(le.l.commentThirdParty,{targetBlock:r(e)},"HandleLoaded")}},{key:"handleCommentChange",value:function(e){var o=this,n=e.addedComments,r=e.deletedComments,i=e.updatedComments,a=e.resolveStatusChangedComments;[].concat(S()(n),S()(r),S()(i),S()(a)).forEach((function(e){var n=e.commentId,r=o.getRecordIdByCommentId(n);r&&o.setCommentData(r,o.commentModule.getCommentData())}))}},{key:"updateComments",value:function(e,o){var n=this.eventColletor,r=n.collectEvent,i=n.getBlockViewByRecordId;this.thirdPartyCommentMap.set(e,o);var a=o.map((function(e){return{commentId:e.commentId,quote:e.quote}}));this.commentModule.amendQuote(a),r(le.l.commentThirdParty,{targetBlock:i(e),comments:o.map((function(e){return Oe(Oe({},e),{},{quote:void 0})}))},"UpdateComments")}},{key:"deleteLoadedThirdParty",value:function(e){this.loadedThirdParty.delete(e)}},{key:"deleteComments",value:function(e){var o=this.eventColletor,n=o.collectEvent,r=o.getBlockViewByRecordId;this.deleteLoadedThirdParty(e),this.thirdPartyCommentMap.delete(e),n(le.l.commentThirdParty,{targetBlock:r(e)},"DeleteComments")}},{key:"getCommentRelativeTop",value:function(e,o){var n,r=null!==(n=e.relativeTopToThirdParty)&&void 0!==n?n:0,i=this.getBlockModel(o);return i?i.getCommentRelativeTop(e):r}},{key:"getCommentRect",value:function(e,o){var n=this.blockManager.getRecordByBlockId(e).id,r=this.thirdPartyCommentMap.get(n),i=null===r||void 0===r?void 0:r.find((function(e){return e.commentId===o}));if(i){var a=Object(Ce.u)(e,this.fold,this.rect,this.blockManager),c=a.blockRect,m=a.visible;return this.combineCommentRect(e,c,i,m)}return null}},{key:"getCommentPosition",value:function(e){var o=this,n=this.thirdPartyCommentMap.get(e);if(n){var r=this.blockManager.getBlockIdsByRecordId(e)[0];if(!r)return[];var i=Object(Ce.u)(r,this.fold,this.rect,this.blockManager),a=i.blockRect,c=i.visible;return n.map((function(e){return[e.commentId,o.combineCommentRect(r,a,e,c)]}))}return[]}},{key:"isCommentIdInThirdPartyComments",value:function(e){var o=this;return!!e&&(!!this.isThirdPartyTypeComment(e)&&S()(this.thirdPartyCommentMap.keys()).some((function(n){return(o.thirdPartyCommentMap.get(n)||[]).some((function(o){return o.commentId===e}))})))}},{key:"setCommentData",value:function(e,o){var n=this,r=this.eventColletor,i=r.collectEvent,a=r.getBlockViewByRecordId;this.blockManager.getBlockIdsByRecordId(e).forEach((function(e){var r=n.getBlockModel(e);r.isThirdPartyCommentBlock&&r.setCommentData(o,n.commentModule)})),i(le.l.commentThirdParty,{targetBlock:a(e)},"SetCommentData")}},{key:"startNewComment",value:function(e,o){var n=this.eventColletor,r=n.collectEvent,i=n.getBlockViewByRecordId,a=this.getBlockModel(e);if(a.isThirdPartyCommentBlock){var c=this.blockManager.getRecordByBlockId(a.id).id,m=a.getServiceTypeAndServiceToken(),l=m.serviceType,d=m.serviceToken,s=a.startNewComment(o,{context:{}});return this.updateComments(c,a.getComments()),r(le.l.commentThirdParty,{targetBlock:i(c),tempCommentId:o},"startNewComment"),{quote:s,serviceType:l,serviceToken:d}}}},{key:"saveComment",value:function(e,o){var n=this,r=this.eventColletor,i=r.collectEvent,c=r.getBlockViewByRecordId,l=this.getBlocksByCommentId(o);return i(le.l.commentThirdParty,{targetBlock:c(l.map((function(e){return e.recordId}))),tempCommentId:e,commentId:o},"SaveComment"),Promise.all(l.map((function(r){return m()(a.a.mark((function i(){var c;return a.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,r.saveCommentMark(e,o);case 2:return n.updateComments(r.record.id,r.getComments()),Object(Ce.G)()||(c=n.blockManager.getBlockViewByBlockIdNotCheck(r.id))&&c.activateComment(o),i.abrupt("return",r.record.id);case 5:case"end":return i.stop()}}),i)})))()})))}},{key:"removeComment",value:function(){var e=m()(a.a.mark((function e(o){var n,r,i,c,m,l,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=this.eventColletor,r=n.collectEvent,i=n.getBlockViewByRecordId,c=this.getBlocksByCommentId(o),r(le.l.commentThirdParty,{targetBlock:i(c.map((function(e){return e.recordId}))),commentId:o},"RemoveComment"),m=Me(c),e.prev=4,m.s();case 6:if((l=m.n()).done){e.next=13;break}return d=l.value,e.next=10,d.removeCommentMark(o);case 10:this.updateComments(d.record.id,d.getComments());case 11:e.next=6;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(4),m.e(e.t0);case 18:return e.prev=18,m.f(),e.finish(18);case 21:case"end":return e.stop()}}),e,this,[[4,15,18,21]])})));return function(o){return e.apply(this,arguments)}}()},{key:"removeTempComment",value:function(){var e=m()(a.a.mark((function e(o){var n,r,i,c,m,l,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=this.eventColletor,r=n.collectEvent,i=n.getBlockViewByRecordId,c=this.getBlocksByCommentId(o),r(le.l.commentThirdParty,{targetBlock:i(c.map((function(e){return e.recordId}))),commentId:o},"removeTempComment"),m=Me(c),e.prev=4,m.s();case 6:if((l=m.n()).done){e.next=13;break}return d=l.value,e.next=10,d.removeTempComment(o);case 10:this.updateComments(d.record.id,d.getComments());case 11:e.next=6;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(4),m.e(e.t0);case 18:return e.prev=18,m.f(),e.finish(18);case 21:case"end":return e.stop()}}),e,this,[[4,15,18,21]])})));return function(o){return e.apply(this,arguments)}}()},{key:"resolveComment",value:function(e){var o=this,n=this.eventColletor,r=n.collectEvent,i=n.getBlockViewByRecordId,c=this.getBlocksByCommentId(e);r(le.l.commentThirdParty,{targetBlock:i(c.map((function(e){return e.recordId}))),commentId:e},"ResolveCommment"),c.forEach(function(){var n=m()(a.a.mark((function n(r){var i;return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,r.resolveComment(e);case 2:(i=o.blockManager.getBlockViewByBlockIdNotCheck(r.id))&&(i.deactivateComment(e),i.removeHoverHighlight(e)),o.updateComments(r.record.id,r.getComments());case 5:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())}},{key:"reopenComment",value:function(e){var o=this,n=this.eventColletor,r=n.collectEvent,i=n.getBlockViewByRecordId,c=Array.from(this.loadedThirdParty).find((function(n){var r=o.blockManager.getBlockIdsByRecordId(n);if(!r.length)return!1;var i=o.getBlockModel(r[0]);return!!i.isThirdPartyCommentBlock&&!!i.getResolvedComments().find((function(o){return o.commentId===e}))}));if(c){var l=this.blockManager.getBlockIdsByRecordId(c).map((function(e){return o.getBlockModel(e)}));l.forEach(function(){var n=m()(a.a.mark((function n(r){return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,r.reopenComment(e);case 2:o.updateComments(r.record.id,r.getComments());case 3:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}()),r(le.l.commentThirdParty,{targetBlock:i(l.map((function(e){return e.recordId}))),commentId:e},"ReopenComment")}}},{key:"activateComment",value:function(e){var o=this,n=this.eventColletor,r=n.collectEvent,i=n.getBlockViewByRecordId,a=this.getBlocksByCommentId(e);a.forEach((function(n){var r=o.blockManager.getBlockViewByBlockIdNotCheck(n.id);r&&r.activateComment(e)})),r(le.l.commentThirdParty,{targetBlock:i(a.map((function(e){return e.recordId}))),commentId:e},"ActivateComment")}},{key:"deactivateComment",value:function(e){var o=this,n=this.eventColletor,r=n.collectEvent,i=n.getBlockViewByRecordId,a=this.getBlocksByCommentId(e);a.forEach((function(n){var r=o.blockManager.getBlockViewByBlockIdNotCheck(n.id);r&&r.deactivateComment(e)})),r(le.l.commentThirdParty,{targetBlock:i(a.map((function(e){return e.recordId}))),commentId:e},"DeactiveComment")}},{key:"addHoverHighlight",value:function(e){var o=this,n=this.eventColletor,r=n.collectEvent,i=n.getBlockViewByRecordId,a=this.getBlocksByCommentId(e);a.forEach((function(n){var r=o.blockManager.getBlockViewByBlockIdNotCheck(n.id);r&&r.addHoverHighlight(e)})),a.length>0&&r(le.l.commentThirdParty,{targetBlock:i(a.map((function(e){return e.recordId}))),commentId:e},"AddHoverHighlight")}},{key:"removeHoverHighlight",value:function(e){var o=this,n=this.eventColletor,r=n.collectEvent,i=n.getBlockViewByRecordId,a=this.getBlocksByCommentId(e);a.forEach((function(n){var r=o.blockManager.getBlockViewByBlockIdNotCheck(n.id);r&&r.removeHoverHighlight(e)})),a.length>0&&r(le.l.commentThirdParty,{targetBlock:i(a.map((function(e){return e.recordId}))),commentId:e},"RemoveHoverHighlight")}}]),e}(),Re=Ee;function Pe(e,o){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);o&&(r=r.filter((function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable}))),n.push.apply(n,r)}return n}function we(e){for(var o=1;o<arguments.length;o++){var n=null!=arguments[o]?arguments[o]:{};o%2?Pe(Object(n),!0).forEach((function(o){d()(e,o,n[o])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Pe(Object(n)).forEach((function(o){Object.defineProperty(e,o,Object.getOwnPropertyDescriptor(n,o))}))}return e}function xe(e,o){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,o){if(!e)return;if("string"===typeof e)return Se(e,o);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Se(e,o)}(e))||o&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,c=!0,m=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return c=e.done,e},e:function(e){m=!0,a=e},f:function(){try{c||null==n.return||n.return()}finally{if(m)throw a}}}}function Se(e,o){(null==o||o>e.length)&&(o=e.length);for(var n=0,r=new Array(o);n<o;n++)r[n]=e[n];return r}var Ae=A.g.isEasysyncOp,je=function(){function e(o){var n=this;u()(this,e),this.isRecordChangeDebounceUpdated=!0,this.commentScroller=void 0,this.eventCollector=void 0,this.activeCommentId=void 0,this.blockManager=void 0,this.rect=void 0,this.fold=void 0,this.transactionHelper=void 0,this.isReady=!1,this.commentIdToRecordIdMap=void 0,this.recordIdToCommentIdMap=void 0,this.commentIdToCommentMap=void 0,this.commentIdToPositionMap=void 0,this.recordIdsToUpdate=void 0,this.token=void 0,this.eventEmitter=void 0,this.pageEventEmitter=void 0,this.numberManager=void 0,this.thirdPartyManager=void 0,this.viewport=void 0,this.selectionAPI=void 0,this.vcController=void 0,this.vcPosition=void 0,this.scrollingDetector=void 0,this.tempCommentIds=new Set,this.commentable=!1,this.timeoutId=null,this.globalCommentLoadedResolver=void 0,this.globalCommentLoadedPromise=new Promise((function(e){n.globalCommentLoadedResolver=e})),this.recordChangeTimeoutSet=new Set,this.disableScrollInVC=Object(Ce.n)(),this.commentPositionFilter=null,this.activateCommentSourceSelection=null,this.updateActivatedCommentToSelectionPos=function(e,o){var r=e.type,i=e.id;if(r===z.j.TEXT){var a=n.commentIdToPositionMap.get(o),c=Object(_.y)();a&&a.top+c<n.commentScroller.scrollTop&&(n.activateCommentSourceSelection={commentId:o,selection:e},n.recordIdsToUpdate.add(n.blockManager.getRecordByBlockId(i).id),n.updatePosition(!0))}},this.restoreCommentPositionToContentTop=function(){if(n.activateCommentSourceSelection){var e=n.activateCommentSourceSelection,o=e.commentId,r=e.selection.id,i=n.getPositionByCommentId(o);n.activateCommentSourceSelection=null;var a=!0;if(i){var c=n.getCommentRect(o,Object(Ce.V)(o));if(c){var m=Object(_.y)();c.top+m<n.commentScroller.scrollTop&&i.top+m>n.commentScroller.scrollTop+n.commentScroller.scrollerClientHeight&&(a=!1),n.recordIdsToUpdate.add(n.blockManager.getRecordByBlockId(r).id),n.updatePosition(a)}}}},this.handleCommentReady=function(){var e=n.eventCollector.collectEvent;if(n.isReady)e(le.l.commentDataReady,{msg:"handleCommentReady is called when it's already ready"});else{n.isReady=!0;var o=n.initCommentRelation();n.setCommentIdToCommentMap(),n.updateAllCommentPosition(!0),n.handleUrlCommentId(),n.triggerReady(),e(le.l.commentDataReady,{initialCommentRelation:o.map((function(e){return{commentId:e[0],targetBlock:n.eventCollector.getBlockViewByRecordId(e[1])}}))})}},this.triggerReady=function(){n.trigger(ke.M.COMMENT_READY,{comments:Array.from(n.commentIdToCommentMap.values())})},this.handleEditorResize=function(){var e;(null===(e=n.scrollingDetector)||void 0===e?void 0:e.getIsScrolling())||n.updateAllCommentPosition()},this.handleRecordChange=function(e){n.isRecordChangeDebounceUpdated=!1;var o=window.setTimeout((function(){n.recordChangeTimeoutSet.delete(o),n.updateCommentRelation(e.recordOps),n.debounceUpdatePosition()}),0);n.recordChangeTimeoutSet.add(o)},this.addCommentRelation=function(e,o){var r=n.commentIdToRecordIdMap.get(e)||new Set;n.commentIdToRecordIdMap.set(e,new Set([].concat(S()(r),S()(o)))),o.forEach((function(o){var r=n.recordIdToCommentIdMap.get(o)||new Set;n.recordIdToCommentIdMap.set(o,new Set([].concat(S()(r),[e])))}))},this.removeCommentRelation=function(e,o){var r;if(n.trigger(ke.M.DELETE_FALLBACK_COMMENT,{commentId:e,recordIds:o}),o){r=new Set(o);var i=n.commentIdToRecordIdMap.get(e);r.forEach((function(e){null===i||void 0===i||i.delete(e)})),(null===i||void 0===i?void 0:i.size)&&(i.forEach((function(e){n.recordIdsToUpdate.add(e)})),n.debounceUpdatePosition())}else r=n.commentIdToRecordIdMap.get(e)||new Set,n.commentIdToRecordIdMap.delete(e);r.forEach((function(o){(n.recordIdToCommentIdMap.get(o)||new Set).delete(e)})),n.commentIdToPositionMap.delete(e)},this.replaceCommentRelation=function(e,o){if(n.commentIdToRecordIdMap.get(e)||!n.commentIdToRecordIdMap.get(o)){var r=n.commentIdToRecordIdMap.get(e)||new Set;setTimeout((function(){n.commentIdToRecordIdMap.delete(e)}),1e3),n.commentIdToRecordIdMap.set(o,r),r.forEach((function(r){var i=n.recordIdToCommentIdMap.get(r)||new Set,a=new Set(i);a.delete(e),a.add(o),n.recordIdToCommentIdMap.set(r,a)}))}},this.updateCommentRelation=function(e){var o=n.eventCollector,r=o.collectEvent,i=o.formatError,a=o.formatRecordOps,c=o.formatRelationChangeInfo,m=[],l=[],d=[];try{e.forEach((function(e){var o=e.id;e.ops.forEach((function(e){if(Object(M.bG)(e)&&"comments"===e.p[0]&&null===e.action.od)S()(e.action.oi).reverse().forEach((function(e){n.addCommentRelation(e,[o]),m.push(c(e,o,"replace null"))})),n.recordIdsToUpdate.add(o);else if(Object(M.bG)(e)&&e.action.od instanceof Object&&e.action.oi instanceof Object){if(n.handleReplaceBlankBlock(e,o,m))return;var r=e.action,i=r.od,a=r.oi,s=S()(i.comments||[]).reverse(),u=S()(a.comments||[]).reverse(),h=s.reduce((function(e,o){return e.set(o,!0),e}),new Map);u.forEach((function(e){if(!h.has(e))return n.recordIdsToUpdate.add(o),m.push(c(e,o,"replace object")),n.addCommentRelation(e,[o]);h.delete(e)}));var v,f=xe(h.keys());try{for(f.s();!(v=f.n()).done;){var p=v.value;n.removeCommentRelation(p,[o]),l.push(c(p,o,"replace object"))}}catch(E){f.e(E)}finally{f.f()}n.handleUpdateTempComment(o)}else if(Object(M.X)(e)){if("comments"===e.p[0]){n.addCommentRelation(e.action.li,[o]),n.recordIdsToUpdate.add(o),m.push(c(e.action.li,o,"li comment"));var g=n.blockManager.getRecord(o);if(g.snapshot.text instanceof Object){var C=Array.from(Object.values(g.snapshot.text.apool.numToAttrib)).filter((function(e){return e[0].startsWith("comment-id-")})).map((function(e){return e[0].slice("comment-id-".length)}))||[];if(C.length){var y=g.snapshot.comments||[];Object(B.xor)(y,C).forEach((function(e){d.push(c(e,o,"li comment")),n.trigger(ke.M.ADDED_FALLBACK_COMMENT,{commentId:e})}))}}}else if("children"===e.p[0]){var k=e.action.li;n.updateInsertCommentRelation(k,"li children",m)}}else if(Object(M.ZH)(e)){if("comments"===e.p[0])n.removeCommentRelation(e.action.ld,[o]),m.push(c(e.action.ld,o,"ld comment"));else if("children"===e.p[0]){var I=e.action.ld;n.updateDeleteCommentRelation(I,"ld children",l)}}else if(Object(M.y)(e)){var b=e.action.oi;if(0===e.p.length&&(null===b||void 0===b?void 0:b.comments))S()(b.comments).reverse().forEach((function(e){m.push(c(e,o,"insert block")),n.addCommentRelation(e,[o])}));else if("cell_set"===e.p[0]){var T=e.action.oi.block_id;n.updateInsertCommentRelation(T,"oi cell_set",m)}else"comments"===e.p[0]&&Object(B.isArray)(e.action.oi)&&(S()(e.action.oi).reverse().forEach((function(e){m.push(c(e,o,"oi block comment")),n.addCommentRelation(e,[o])})),n.recordIdsToUpdate.add(o))}else if(Object(M.P)(e))if("cell_set"===e.p[0]){var O=e.action.od.block_id;n.updateDeleteCommentRelation(O,"od cell_set",l)}else"children"===e.p[0]&&e.action.od.forEach((function(e){n.updateDeleteCommentRelation(e,"od children",l)}));else Ae(e)&&n.handleUpdateTempComment(o)}))})),n.isLazyRecordAllDone&&(m.length>0||l.length>0||d.length>0)&&r(le.l.commentUpdateRelation,{recordOps:a(e),relationChange:{addRelation:m,removeRelation:l,fallbackComment:d}})}catch(s){r(le.l.exception,we(we({},i(s instanceof Error?s:void 0)),{},{msg:"updateCommentRelation failed",recordOps:a(e),addRelation:m,removeRelation:l,fallbackComment:d})),n.rebuildCommentRelation()}},this.findTempCommentsByRecordId=function(e){return Array.from(n.tempCommentIds).filter((function(o){var r=n.getRecordsByCommentId(o);return r&&r.has(e)}))},this.handleUpdateTempComment=function(e){var o=n.findTempCommentsByRecordId(e);if(0!==o.length){try{var r=n.blockManager.getRecord(e);if(!Object(H.S)(r.snapshot))return}catch(f){console.log("[CommentModule] can't get record in updateTempComment",f)}var i,a=n.blockManager.getBlockIdsByRecordId(e),c=o.map((function(e){return!1})),m=xe(a);try{for(m.s();!(i=m.n()).done;){for(var l=i.value,d=n.blockManager.getBlockModelByBlockId(l),s=0;s<o.length;s++){var u,h=Object(Ce.y)(o[s]);(null===(u=d.zoneState.getEntities([[h]])[0])||void 0===u?void 0:u.attributes[h])&&(c[s]=!0)}if(c.every((function(e){return e})))break}}catch(p){m.e(p)}finally{m.f()}for(var v=0;v<o.length;v++)c[v]||n.handleCancelAddComment(o[v],"TextDelete")}},this.handleReplaceBlankBlock=function(e,o,r){if(0===e.p.length&&["pending","blank"].includes(e.action.od.type)){if(!n.blockManager.getBlockModelsByRecordId(o).length)return!0;var i=n.initCommentRelation(o,!0);return r.push.apply(r,S()(i.map((function(e){return n.eventCollector.formatRelationChangeInfo(e[0],e[1],"replace blank block",!0)})))),!0}return!1},this.updateInsertCommentRelation=function(e,o,r){try{n.blockManager.recordManager.traverse(e,(function(e){var i=e.id,a=n.blockManager.getRecord(i);return a.snapshot.comments&&a.snapshot.comments.length>0&&(S()(a.snapshot.comments).reverse().forEach((function(e){n.addCommentRelation(e,[i]),r.push(n.eventCollector.formatRelationChangeInfo(e,i,o,!0))})),n.recordIdsToUpdate.add(i)),!0}))}catch(i){throw n.eventCollector.collectEvent(le.l.exception,{msg:"updateInsertCommentRelation failed",targetBlock:n.eventCollector.getBlockViewByRecordId(e)},o),i}},this.updateDeleteCommentRelation=function(e,o,r){try{n.blockManager.recordManager.traverse(e,(function(i){var a=i.id;if(n.blockManager.getBlockIdsByRecordId(a).filter((function(e){return!Object(Ce.m)(e,n.blockManager)})).length>0)return n.handleUpdateTempComment(a),!0;var c=n.recordIdToCommentIdMap.get(a);return c?(n.recordIdToCommentIdMap.delete(a),n.thirdPartyManager.deleteComments(e),c.forEach((function(e){n.removeCommentRelation(e,[a]),r.push(n.eventCollector.formatRelationChangeInfo(e,a,o,!0))})),!0):(n.thirdPartyManager.deleteLoadedThirdParty(e),!0)}))}catch(i){throw n.eventCollector.collectEvent(le.l.exception,{msg:"updateDeleteCommentRelation failed",targetBlock:n.eventCollector.getBlockViewByRecordId(e)},o),i}},this.initCommentRelation=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n.token,o=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=[];return n.blockManager.recordManager.traverse(e,(function(e){var i=e.snapshot,a=e.id;return!i.comments||(S()(i.comments).reverse().forEach((function(e){n.addCommentRelation(e,[a]),r.push([e,a])})),o&&i.comments.length>0&&n.recordIdsToUpdate.add(a),!0)})),r},this.updatePosition=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],o=n.calcCommentPosition(n.recordIdsToUpdate);n.recordIdsToUpdate.clear(),n.onPositionUpdate(o,"DebounceUpdatePosition"),n.handleUrlCommentId(),0===n.recordChangeTimeoutSet.size&&(n.isRecordChangeDebounceUpdated=!0),n.trigger(ke.M.COMMENT_POSITION_CHANGE,{commentIdToPositionMap:n.commentIdToPositionMap,animate:e})},this.debounceUpdatePosition=Object(B.debounce)(this.updatePosition,300),this.handleUndoRedo=function(e,o){n.handleTransaction({options:{from:M.H.local},recordOps:e,op:o})},this.diffAndPatchTextCommentChange=function(e,o,n,r,i){var a=0===n.text.initialAttributedTexts.text[0].length,c=Object(Ce.J)(r,i),m=c.deletedSet,l=c.addedSet;if(0!==m.size||0!==l.size){var d=Object(B.isNull)(n.comments),s=n.comments||[];a&&s.forEach((function(e){return m.add(e)}));var u=[];m.forEach((function(e){var o=s.indexOf(e);-1!==o&&u.push(o)})),u.sort((function(e,o){return o-e})),d?o.replace(e,["comments"],Array.from(l)):(u.forEach((function(n){o.remove(e,["comments",n])})),l.forEach((function(n){-1===s.indexOf(n)&&o.insert(e,["comments",0],n)})))}},this.handleEasysyncTransaction=function(e,o){try{var r=o.record,i=o.id,a=r.snapshot,c=Object(Ce.v)(a.text),m=n.getCommentsByRecordId(i);n.diffAndPatchTextCommentChange(i,e,a,m||new Set,c)}catch(u){var l=n.eventCollector,d=l.collectEvent,s=l.formatError;d(le.l.exception,we(we({},s(u)),{},{msg:"handleEasysyncTransaction failed"}))}},this.handleTransaction=function(e){var o=e.options,r=e.recordOps,i=e.op;o.from!==M.H.local||o.extra&&o.extra.skipCommentHandleTransaction||r.forEach((function(e){var o,r=xe(e.ops);try{for(r.s();!(o=r.n()).done;){var a=o.value;if("comments"===a.p[0])return;if(Ae(a))return void n.handleEasysyncTransaction(i,e)}}catch(c){r.e(c)}finally{r.f()}e.ops.forEach((function(o){if(Object(M.bG)(o)){var r="text"===o.p[0],a=0===o.p.length&&Object(H.S)(e.record.snapshot);(r||a)&&n.diffAndPatchTextCommentChange(e.id,i,e.record.snapshot,Object(Ce.v)(r?o.action.od:o.action.od.text),Object(Ce.v)(r?o.action.oi:o.action.oi.text))}else if(Object(M.y)(o)&&0===o.p.length&&o.action.oi){var c=o.action.oi;if(!c.text)return;var m=Array.from(Object(Ce.v)(c.text));if(0===m.length)return;void 0===c.comments?i.insert(e.id,["comments"],m):i.replace(e.id,["comments"],m)}}))}))},this.handleViewportLocked=function(){var e,o=n.eventCollector.collectEvent;(null===(e=n.scrollingDetector)||void 0===e?void 0:e.getIsScrolling())||(o(le.l.handleViewportLocked,{stage:"start"}),n.updateAllCommentPosition(),o(le.l.handleViewportLocked,{stage:"end"}))},this.getTempCommentIds=function(){return n.tempCommentIds},this.getSource=function(e){return"Toolbox"===e||"Mindmap"===e||"Sheet"===e||"Bitable"===e?"entrance_hover_click":"SuspensionComment"===e?"entrance_right_click":""},this.triggerStartNewDocComment=Object(B.debounce)((function(e){var o,r=n.eventCollector,i=r.collectEvent,a=r.getBlockViewByBlockId;i(le.l.triggerStartNewComment,{isThirdParty:null!==(o=e.isThirdPartyComment)&&void 0!==o&&o,targetBlocks:e.selectedBlocks.map((function(e){return a(e.id)}))},e.callSource),Object(T.collectEvent)("ccm_comment_view",{source:n.getSource(e.callSource),comment_type:"part_comment"}),n.trigger(ke.M.START_NEW_DOC_COMMENT,e)}),200,{leading:!0,trailing:!0}),this.handleCancelAddComment=function(){var e=m()(a.a.mark((function e(o,r){var i,c,m,l,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=n.eventCollector,c=i.collectEvent,m=i.getBlockViewByBlockId,n.tempCommentIds.delete(o),l=n.commentIdToRecordIdMap.get(o)||new Set,(d=Array.from(l).reduce((function(e,o){var r=n.blockManager.getBlockIdsByRecordId(o);return e.push.apply(e,S()(r)),e}),[])).filter((function(e){return Object(H.f)(n.blockManager.getBlockViewByBlockId(e))})).forEach((function(e){n.transactionHelper.removeLocalCommentMark(o,e)})),e.next=7,n.thirdPartyManager.removeTempComment(o);case 7:n.removeCommentRelation(o),n.debounceUpdatePosition(),n.trigger(ke.M.CANCEL_ADD_COMMENT,{commentId:o,blockIds:d}),c(le.l.cancelAddComment,{tempCommentId:o,targetBlocks:m(d)},r);case 11:case"end":return e.stop()}}),e)})));return function(o,n){return e.apply(this,arguments)}}(),this.handleAddComment=function(e,o){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ke.K.LOCAL,i=arguments.length>3?arguments[3]:void 0,a=n.eventCollector,c=a.collectEvent,m=a.getBlockViewByRecordId,l=a.formatError,d=n.commentIdToRecordIdMap.get(e),s=n.findComment(o),u={commentId:o,tempCommentId:e,targetBlocks:m(Array.from(null!==d&&void 0!==d?d:[]))};if(n.commentIdToCommentMap.delete(e),s&&n.commentIdToCommentMap.set(o,s),s){var h=Object(Ce.t)(s);if(!h&&r===ke.K.LOCAL&&d&&d.size>0)n.applyAddComment(e,o),d.forEach((function(e){return n.recordIdsToUpdate.add(e)})),n.replaceCommentRelation(e,o),n.debounceUpdatePosition(),n.thirdPartyManager.saveComment(e,o).then((function(o){n.commentIdToPositionMap.delete(e),o.length>0&&n.addCommentPosition(new Set(o))})).catch((function(e){return c(le.l.exception,we(we(we({},u),l(e)),{},{msg:"handleAddComment failed: save third party comment failed"}),i)})),c(le.l.afterAddComment,we({},u),i);else if(h||r!==ke.K.LOCAL||d&&0!==d.size){if(!h&&r===ke.K.REMOTE){var v=n.commentIdToRecordIdMap.get(o);v&&v.size>0&&(v.forEach((function(e){return n.recordIdsToUpdate.add(e)})),c(le.l.exception,we(we({},u),{},{msg:"handleAddComment warning: comments position list updated for remote collaboration"}),i),n.debounceUpdatePosition())}}else c(le.l.exception,we(we({},u),{},{msg:"handleAddComment failed: tempCommentId related to no records"}),i);e!==o&&(n.trigger(ke.M.ADDED_COMMENT,{prevCommentId:e,commentId:o,source:r}),n.commentIdToPositionMap.delete(e),n.tempCommentIds.delete(e),c(le.l.doReplaceTempComment,we({},u),i))}else c(le.l.exception,we(we({},u),{},{msg:"handleAddComment failed: can't find comment entity"}),i)},this.handleUpdateComment=function(e){var o=e.commentId;n.commentIdToCommentMap.set(o,e),n.trigger(ke.M.UPDATE_COMMENT,{commentId:o}),Array.from(n.commentIdToRecordIdMap.get(o)||[]).forEach((function(e){return n.recordIdsToUpdate.add(e)}))},this.handleRemove=function(){var e=m()(a.a.mark((function e(o){var r,i,c,m,l,d,s,u,h,v=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=v.length>1&&void 0!==v[1]?v[1]:ke.K.LOCAL,i=v.length>2?v[2]:void 0,c=v.length>3?v[3]:void 0,m=n.eventCollector,l=m.collectEvent,d=m.getBlockViewByRecordId,s=Array.from(n.getRecordsByCommentId(o)||[]),e.next=7,n.thirdPartyManager.removeComment(o);case 7:if(n.removeCommentPosition(o),r!==ke.K.LOCAL){e.next=16;break}if(u=n.commentIdToCommentMap.get(o),h=u&&Object(Ce.d)(u),!(n.tempCommentIds.has(o)||h&&o===h)){e.next=14;break}return n.handleCancelAddComment(o,"SDKCommentChange"),e.abrupt("return");case 14:n.applyDeleteComment(o),l(le.l.afterDeleteComment,{targetBlocks:d(s),commentId:o,replyId:c,type:r},i);case 16:n.commentIdToCommentMap.delete(o),n.trigger(ke.M.DELETE_COMMENT,{commentId:o,source:r});case 18:case"end":return e.stop()}}),e)})));return function(o){return e.apply(this,arguments)}}(),this.handleReopen=function(e){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ke.K.LOCAL,r=arguments.length>2?arguments[2]:void 0,i=n.eventCollector,a=i.collectEvent,c=i.getBlockViewByRecordId,m=n.commentIdToCommentMap.get(e);if(e&&m){n.reopenComment(m),n.thirdPartyManager.reopenComment(e),n.commentIdToCommentMap.set(e,m);var l=n.getRecordsByCommentId(e);l&&n.addCommentPosition(l),n.trigger(ke.M.REOPEN_COMMENT,{commentId:e,source:o}),a(le.l.reopenComment,{commentId:e,targetBlocks:c(Array.from(null!==l&&void 0!==l?l:[]))},r)}else a(le.l.exception,{msg:"handleReopen failed: commentId or comment is undefined",commentId:e},r)},this.getCommentByCommentId=function(e){return n.commentIdToCommentMap.get(e)},this.getCommentIsFinished=function(e){var o=n.getCommentByCommentId(e);return!o||Object(Ce.O)(o)},this.getPositionByCommentId=function(e){return n.commentIdToPositionMap.get(e)},this.getDocComments=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],o=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=Array.from(n.commentIdToCommentMap.values());return o&&(r=r.filter((function(e){var o=e.commentId,r=n.commentIdToRecordIdMap.get(o);return!!(r&&r.size>0)||!Object(Ce.V)(o)&&!!n.thirdPartyManager.isCommentIdInThirdPartyComments(o)}))),Object(Ce.x)(r,{type:"doc",filterOutFinished:e})},this.getWholeComments=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return Object(Ce.x)(Array.from(n.commentIdToCommentMap.values()),{type:"whole",filterOutFinished:e})},this.getAllComments=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return Object(Ce.x)(Array.from(n.commentIdToCommentMap.values()),{type:"all",filterOutFinished:e})},this.doScrollToComment=function(){var e=m()(a.a.mark((function e(o){var r,i,c,m;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=o.commentId,i=o.panelTop,c=o.overrideStrategy,m=n.getBlockModelsByCommentId(r),e.t0=m[0],!e.t0){e.next=6;break}return e.next=6,n.fold.forceShowFoldedBlock(m[0].id,n.editable);case 6:return e.next=8,n.commentScroller.scrollToComment(r,"doScrollToComment",{panelTop:i,overrideStrategy:c});case 8:case"end":return e.stop()}}),e)})));return function(o){return e.apply(this,arguments)}}(),this.activeCommentChangeQueue=[],this.isActivatingComment=!1,this.activeCommentChange=function(e){var o;e.activeCommentId!==(null===(o=n.activateCommentSourceSelection)||void 0===o?void 0:o.commentId)&&n.restoreCommentPositionToContentTop(),n.activeCommentChangeQueue.push(e),n.flushActiveCommentChangeQueue("activeCommentChange")},this.flushActiveCommentChangeQueue=function(){var e=m()(a.a.mark((function e(o){var r,i,c,m;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.eventCollector,i=r.collectEvent,c=r.formatError,i(le.l.flushActiveCommentChange,{isActivatingComment:n.isActivatingComment,queue:n.activeCommentChangeQueue.map((function(e){return{pre:e.prevActiveCommentId,now:e.activeCommentId}})),activatingCommentId:n.activeCommentId},o),!n.isActivatingComment){e.next=4;break}return e.abrupt("return");case 4:if(!(n.activeCommentChangeQueue.length>0)){e.next=16;break}return m=n.activeCommentChangeQueue.shift(),e.prev=6,e.next=9,n.doActiveCommentChange(m);case 9:e.next=16;break;case 11:e.prev=11,e.t0=e.catch(6),n.isActivatingComment=!1,n.flushActiveCommentChangeQueue("FailedRetry"),i(le.l.exception,we(we({},c(e.t0)),{},{msg:"doActiveCommentChange failed"}));case 16:case"end":return e.stop()}}),e,null,[[6,11]])})));return function(o){return e.apply(this,arguments)}}(),this.doActiveCommentChange=function(){var e=m()(a.a.mark((function e(o){var i,c,m,l,d,s,u,h,v,f,p,g,C;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.isActivatingComment=!0,m=n.eventCollector.collectEvent,l=o.activeCommentId,d=o.prevActiveCommentId,s=o.callSource,u=o.fromOutside,h=o.source,v=o.isCommentPanelShow,f=o.mobileDisplayMode,p=o.skipScroll,g=o.panelTop,C=o.complete,n.activeCommentId=l,n.trigger(ke.M.ACTIVE_COMMENT_CHANGE_BEFORE_SCROLL,o),!l||p||(null===(i=n.vcController)||void 0===i?void 0:i.isFollow)&&n.disableScrollInVC&&(null===(c=n.vcPosition)||void 0===c?void 0:c.core.state.isPresenterV2)){e.next=8;break}return e.next=8,n.doScrollToComment({commentId:l,panelTop:g,overrideStrategy:"Editor"===h?r.MinimizeScroll:void 0});case 8:n.trigger(ke.M.ACTIVE_COMMENT_CHANGE,o),m(le.l.activeCommentChange,{fromOutside:u,activeCommentId:l,panelTop:g,prevActiveCommentId:d,isCommentPanelShow:v,mobileDisplayMode:f,source:h},s),n.isActivatingComment=!1,n.flushActiveCommentChangeQueue("doActiveCommentChange"),null===C||void 0===C||C(l);case 13:case"end":return e.stop()}}),e)})));return function(o){return e.apply(this,arguments)}}(),this.hoverCommentChange=function(e){var o=n.eventCollector.collectEvent;n.trigger(ke.M.HOVER_COMMENT_CHANGE,e),o(le.l.hoverCommentChange,we({},e))},this.handleCommentChange=function(e,o){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{type:ke.K.REMOTE},i=n.eventCollector.collectEvent;if(!n.isReady)return e.forEach((function(e){return n.commentIdToCommentMap.set(e.commentId,e)})),void i(le.l.commentChange,{type:r.type,extra:"CommentChange triggered before isReady state ready",addedComments:e.map((function(e){return e.commentId}))});var a=o.addedComments,c=o.deletedComments,m=o.resolveStatusChangedComments,l=o.updatedComments;i(le.l.commentChange,{addedComments:a.map((function(e){return e.commentId})),deletedComments:c.map((function(e){return e.commentId})),resolveStatusChangedComments:m.map((function(e){return e.commentId})),updatedComments:l.map((function(e){return e.commentId})),type:r.type}),a.forEach((function(e){var o=e.commentId,i=Object(Ce.d)(e);n.handleAddComment(i,o,r.type,"SDKCommentChange")})),c.forEach((function(e){var o=e.commentId;n.handleRemove(o,r.type,"SDKCommentChange")})),m.forEach((function(e){var o=e.commentId;(Object(Ce.O)(e)?n.handleResolve:n.handleReopen)(o,r.type,"SDKCommentChange")})),l.forEach((function(e){n.handleUpdateComment(e)})),n.recordIdsToUpdate.size&&n.debounceUpdatePosition(),n.thirdPartyManager.handleCommentChange(o)},this.setGlobalCommentLoaded=function(){var e;null===(e=n.globalCommentLoadedResolver)||void 0===e||e.call(n,!0)},this.setCommentsFilter=function(e){n.commentPositionFilter=e,n.onPositionUpdate(Array.from(n.commentIdToPositionMap.keys()),"SetCommentFilter")},this.handleResolve=function(e){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ke.K.LOCAL,r=arguments.length>2?arguments[2]:void 0,i=n.eventCollector.collectEvent,a=n.commentIdToCommentMap.get(e);e&&a?(n.resolveComment(a),n.thirdPartyManager.resolveComment(e),n.commentIdToCommentMap.set(e,a),n.debounceUpdatePosition(),n.removeCommentPosition(e),n.trigger(ke.M.RESOLVE_COMMENT,{commentId:e,source:o}),i(le.l.resolveComment,{commentId:e},r)):i(le.l.exception,{msg:"handleResolve failed: commentId or comment is undefined",commentId:e},r)},this.applyDeleteComment=function(e){var o=Array.from(n.getRecordsByCommentId(e)||[]),r=n.transactionHelper.splitRecord(o),i=r.textual,a=r.nonTextual;n.blockManager.applyTransaction("resolve comment",(function(o){n.transactionHelper.applyDeleteTextComment(e,i,o),n.transactionHelper.applyDeleteBlockComment(e,a,o)}),{from:M.H.local,undoable:!1,extra:{skipCommentHandleTransaction:!0}})},this.updateAllCommentPosition=function(){var e,o=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=xe(n.recordIdToCommentIdMap.keys());try{for(r.s();!(e=r.n()).done;){var i=e.value;n.recordIdsToUpdate.add(i)}}catch(a){r.e(a)}finally{r.f()}o?(n.debounceUpdatePosition.cancel(),n.updatePosition()):n.debounceUpdatePosition()},this.applyAddComment=function(e,o){var r=n.commentIdToRecordIdMap.get(e)||[],i=n.transactionHelper.splitRecord(Array.from(r)),a=i.textual,c=i.nonTextual;n.blockManager.applyTransaction("apply comment",(function(r){n.transactionHelper.applyAddTextComment(e,o,a,r),n.transactionHelper.applyAddBlockComment(o,c,r)}),{from:M.H.local,undoable:!1,extra:{skipCommentHandleTransaction:!0}}),n.trigger(ke.M.COMMENT_TRANSACTION_APPLY,{tempCommentId:e,commentId:o})},this.getCommentable=function(){return n.commentable},this.getIsReady=function(){return n.isReady},this.rebuildCommentRelation=function(){n.recordIdToCommentIdMap.clear(),n.commentIdToRecordIdMap.clear(),n.commentIdToPositionMap.clear(),n.initCommentRelation(),n.updateAllCommentPosition(!0)},this.blockManager=o.blockManager,this.eventCollector=function(e){var o={},n=Object(B.throttle)((function(){Object(W.N)("docx_comment_dev",{action:"batch",data:JSON.stringify(o),call_source:"batch"}),o={}}),2e3,{trailing:!0,leading:!1}),r=function(o){try{return Object(B.isArray)(o)?o.map((function(o){return Object(Y.h)(o,e)})):Object(Y.h)(o,e)}catch(n){return o}};return{getBlockViewByRecordId:r,getBlockViewByBlockId:function(o){try{return Object(B.isArray)(o)?o.map((function(o){return Object(Y.H)(o,e)})):Object(Y.H)(o,e)}catch(n){return o}},collectEvent:function(e,r,i){o[(new Date).toISOString()]={action:e,data:r,callSource:i},n()},formatError:function(e){return{message:null===e||void 0===e?void 0:e.message,err:e,stack:null===e||void 0===e?void 0:e.stack}},formatRecordOps:function(e){return e.map((function(e){return{blockInfo:r(e.id),ops:e.ops.map((function(e){return{opAction:e.subType?"easysync":Object.keys(e.action),p:e.p}}))}}))},formatRelationChangeInfo:function(e,o,n){return{commentId:e,blockInfo:arguments.length>3&&void 0!==arguments[3]&&arguments[3]?r(o):o,reason:n}}}}(this.blockManager),this.rect=o.rect,this.fold=o.fold,this.token=o.token,this.transactionHelper=new ye({blockManager:this.blockManager,eventCollector:this.eventCollector}),this.eventEmitter=new q.i,this.numberManager=new be,this.thirdPartyManager=new Re(this.rect,this.fold,this.blockManager,this,this.eventCollector),this.commentScroller=new me(this,this.blockManager,o.viewport,o.scroller),this.commentIdToRecordIdMap=new Map,this.recordIdToCommentIdMap=new Map,this.commentIdToCommentMap=new Map,this.commentIdToPositionMap=new Map,this.pageEventEmitter=o.pageEventEmitter,this.viewport=o.viewport,this.selectionAPI=o.selectionAPI,this.scrollingDetector=o.scrollingDetector,this.commentable=o.commentable,this.vcController=o.vcController,this.recordIdsToUpdate=new Set,this.blockManager.recordManager.on(M.q.INTERCEPT_CHANGE,this.handleTransaction),q.S.on(G.r.BEFORE_UNDO_REDO,this.handleUndoRedo),this.pageEventEmitter.on(K.R.CLIENTVAR_APPLY_ALL_DONE,this.updateAllCommentPosition),this.pageEventEmitter.on(R.h,this.handleViewportLocked)}return v()(e,[{key:"isLazyRecordAllDone",get:function(){var e;return!!(null===(e=this.blockManager.lazyRecordStatus)||void 0===e?void 0:e.isAllDone)}}]),v()(e,[{key:"on",value:function(e,o){this.eventEmitter.on(e,o)}},{key:"off",value:function(e,o){this.eventEmitter.off(e,o)}},{key:"once",value:function(e,o){this.eventEmitter.once(e,o)}},{key:"calcCommentPositionByBlockId",value:function(e){return this.calcCommentPosition(new Set([this.blockManager.getRecordByBlockId(e).id]))}},{key:"calcCommentPosition",value:function(e){var o=this,n=this.eventCollector,r=n.collectEvent,i=n.formatError,a=[];return e.forEach((function(e){try{var n=o.recordIdToCommentIdMap.get(e);if(!n||!o.thirdPartyManager.isLoaded(e))return;n.forEach((function(n){o.commentIdToPositionMap.delete(n);var r=o.getCommentByCommentId(n);if(r&&!Object(Ce.O)(r)&&!o.isThirdPartyComment(n,e)){var i=Object(Ce.V)(n),c=o.getCommentRect(n,i);c&&(o.commentIdToPositionMap.set(n,c),a.push(n))}})),o.thirdPartyManager.getCommentPosition(e).forEach((function(e){var n=w()(e,2),r=n[0],i=n[1];o.commentIdToPositionMap.set(r,i),a.push(r)}))}catch(c){r(le.l.exception,we(we({},i(c instanceof Error?c:void 0)),{},{msg:"calcCommentPosition failed"}))}})),this.sortCommentPosition(),a}},{key:"addCommentPosition",value:function(e){var o=this.calcCommentPosition(e);this.onPositionUpdate(o,"AddCommentPosition"),this.trigger(ke.M.COMMENT_POSITION_CHANGE,{commentIdToPositionMap:this.commentIdToPositionMap})}},{key:"removeCommentPosition",value:function(e){this.commentIdToPositionMap.delete(e),this.sortCommentPosition(),this.onPositionUpdate([e],"RemoveCommentPosition"),this.trigger(ke.M.COMMENT_POSITION_CHANGE,{commentIdToPositionMap:this.commentIdToPositionMap})}},{key:"sortCommentPosition",value:function(){var e=S()(this.commentIdToPositionMap.entries());e.sort(Ce.c),this.commentIdToPositionMap=new Map(e)}},{key:"handleUrlCommentId",value:function(){var e=m()(a.a.mark((function e(){var o,n,r,i,c,m,l,d,s,u,h,v,f,p=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=this.eventCollector.collectEvent,n=T.urlHelper.parseQuery(T.history.location.search),r=n.comment_id,i=n.reply_id,c=r&&Array.isArray(r)?r[0]:r,m=i&&Array.isArray(i)?i[0]:i,c){e.next=6;break}return e.abrupt("return");case 6:if(l=function(){T.urlHelper.cleanParamFromSearch(location.href,"comment_id"),T.urlHelper.cleanParamFromSearch(location.href,"reply_id")},d=this.commentIdToPositionMap.get(c),s=this.commentIdToCommentMap.get(c),o(le.l.urlJump,{commentId:c,replyId:m,commentPosExist:d,commentExist:!!s,isWhole:!!s&&Object(Ce.t)(s)}),!s||!Object(Ce.t)(s)){e.next=16;break}return h=(u=s).commentId,v=u.replyList,f=u.commentList,l(),e.next=15,this.scrollToWholeComment(h,(v||f)[0].replyId);case 15:return e.abrupt("return");case 16:d&&setTimeout((function(){p.activateComment(c,m||"",le.M.url),l(),p.activeCommentId=c}));case 17:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"trigger",value:function(e,o){this.eventEmitter.trigger(e,[o])}},{key:"getCommentRect",value:function(e,o){var n=this;try{var r,i=this.getBlockModelsByCommentId(e),a=this.blockManager,c=this.thirdPartyManager.isThirdPartyComment(e),m=null;if(e===(null===(r=this.activateCommentSourceSelection)||void 0===r?void 0:r.commentId)){var l=this.activateCommentSourceSelection.selection,d=l.id,s=l.selection;if(a.hasBlockModelByBlockId(d)){var u=a.getBlockModelByBlockId(d),h=Object(Ce.l)(u,e,o);if(h){var v=Object(B.clamp)(s.start,h[0],h[1]),f=Object(B.clamp)(s.end,h[0],h[1]),p=this.rect.getRangeRect(d,[v,f]);return m=Object(Ce.tQ)(p,d)}}}return i.forEach((function(r){var i=r.id,l=n.fold.isShow(i),d=null,s=a.hasBlockViewByBlockId(i)?a.getBlockViewByBlockId(i):null;if(c)d=n.thirdPartyManager.getCommentRect(i,e);else if(null!=s&&Object(H.f)(s)&&l){var u=Object(Ce.l)(s.model,e,o);if(u){var h=n.rect.getRangeRect(s.id,u);d=Object(Ce.tQ)(h,s.id)}else d=we(we({},n.rect.getBlockRect(i)),{},{blockId:i})}else{d=we(we({},Object(Ce.u)(i,n.fold,n.rect,a).blockRect),{},{blockId:i});var v=s&&le.i[s.type],f=s&&le.D[s.type];j.S.isMobile&&!j.S.isIPad&&f&&(v=f),d&&v&&(d=we({},d),Object.keys(v).forEach((function(e){d&&(d[e]+=v[e])})))}if(d&&m){var p=Object(Ce.GF)(d,m,n.blockManager);p?m=we(we({},p),{},{visible:l}):(d.top<m.top||d.top===m.top&&d.left<m.left)&&(m=we(we({},d),{},{visible:l}))}else d&&(m=we(we({},d),{},{visible:l}))})),m}catch(k){var g=this.eventCollector,C=g.collectEvent,y=g.formatError;return C(le.l.exception,we(we({msg:"getCommentRect failed"},y(k instanceof Error?k:void 0)),{},{commentId:e})),null}}},{key:"isThirdPartyTypeComment",value:function(e){return this.thirdPartyManager.isThirdPartyTypeComment(e)}},{key:"isThirdPartyComment",value:function(e,o){return this.thirdPartyManager.isThirdPartyComment(e,o)}},{key:"isThirdPartyCommentLoaded",value:function(e){return this.thirdPartyManager.isLoaded(e)}},{key:"isThirdPartyBlock",value:function(e){return this.thirdPartyManager.isThirdPartyBlock(e)}},{key:"handleThirdPartyLoaded",value:function(e,o){var n=this;this.handleThirdPartyUpdated(e,o),this.thirdPartyManager.handleLoaded(e),this.once(ke.M.COMMENT_POSITION_CHANGE,(function(){n.trigger(ke.M.THIRD_PARTY_COMMENT_LOADED,{recordId:e})}))}},{key:"setVcPosition",value:function(e){this.vcPosition=e}},{key:"handleThirdPartyUpdated",value:function(e,o){this.thirdPartyManager.updateComments(e,o),this.isRecordChangeDebounceUpdated=!1,this.recordIdsToUpdate.add(e),this.debounceUpdatePosition()}},{key:"handleThirdPartyCommentDidAdd",value:function(e,o){var n=this.findComment(o);if(n){var r=this.getRecordsByCommentId(o);if(!(r&&r.size>0)){var i=Object(Ce.d)(n);this.addCommentRelation(i,[e]),this.applyAddComment(i,o),this.replaceCommentRelation(i,o),this.commentIdToPositionMap.delete(i),this.recordIdsToUpdate.add(e),this.debounceUpdatePosition()}}}},{key:"startNewDocComment",value:function(){var e=m()(a.a.mark((function e(o){var n,r,i,c,l,d,s,u,h,v=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.info("[CommentModule] startNewDocComment",o),n=function(){var e=m()(a.a.mark((function e(){var n,r,i,c,l,d,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=function(){var e=m()(a.a.mark((function e(o){var n,r,i,c,m;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Object(D.dE)(v.fold,o,v.blockManager),i=r.blockList,c=r.isMultiSel,e.next=3,Object(D.g)({fold:v.fold,blockList:i,shouldIgnoreFold:c,blockManager:v.blockManager,forceFindBlockGroups:[N.B.QUOTE_CONTAINER],recursive:(1!==o.length||o[0].type!==z.j.BLOCK||(null===(n=v.blockManager.getBlockModelByBlockIdNotCheck(o[0].id))||void 0===n?void 0:n.type)!==N.B.TASK)&&void 0});case 3:return m=e.sent,e.abrupt("return",m.map((function(e){return{id:e.id,type:z.j.BLOCK}})));case 5:case"end":return e.stop()}}),e)})));return function(o){return e.apply(this,arguments)}}(),r=[],i=[],c=xe(o.selectedBlocks),e.prev=4,c.s();case 6:if((l=c.n()).done){e.next=24;break}if((d=l.value).type!==z.j.BLOCK){e.next=11;break}return i.push(d),e.abrupt("continue",22);case 11:if(!i.length){e.next=21;break}return e.t0=r.push,e.t1=r,e.t2=S.a,e.next=17,n(i);case 17:e.t3=e.sent,e.t4=(0,e.t2)(e.t3),e.t0.apply.call(e.t0,e.t1,e.t4),i.length=0;case 21:r.push(d);case 22:e.next=6;break;case 24:e.next=29;break;case 26:e.prev=26,e.t5=e.catch(4),c.e(e.t5);case 29:return e.prev=29,c.f(),e.finish(29);case 32:if(!i.length){e.next=41;break}return e.t6=r.push,e.t7=r,e.t8=S.a,e.next=38,n(i);case 38:e.t9=e.sent,e.t10=(0,e.t8)(e.t9),e.t6.apply.call(e.t6,e.t7,e.t10);case 41:return s=new Set,e.abrupt("return",r.filter((function(e){return!s.has(e.id)&&(s.add(e.id),!0)})));case 43:case"end":return e.stop()}}),e,null,[[4,26,29,32]])})));return function(){return e.apply(this,arguments)}}(),e.next=4,n();case 4:if(o.selectedBlocks=e.sent,r=this.eventCollector.collectEvent,i=o.callSource,c=o.selectedBlocks,l=o.isThirdPartyComment,1!==c.length){e.next=11;break}l?this.startNewThirdPartyComment(c[0],i):this.startNewDocCommentOnSingleBlock(c[0],i),e.next=22;break;case 11:if(!(c.length>1)){e.next=21;break}if(d=this.blockManager.editorAPI,s=d.modelService,!(u=d.getService(U.N,{optional:!0}))||c.every((function(e){var o=s.getBlockModelByBlockId(e.id);if(!o)return!1;var n=u.canBlockEdit(o.record,o.type,{type:"UPDATE_ATTRIBUTE",changedKey:"comments",newValue:"unknown"});return n||(h=o.record),n}))){e.next=18;break}return Object(V.A)({op_source:"tool",op_type:"comment",edit_type:"UPDATE_ATTRIBUTE",interceptedRecord:h}),e.abrupt("return");case 18:this.startNewDocCommentOnMultiBlocks(c,i),e.next=22;break;case 21:r(le.l.exception,{msg:"startNewDocComment failed: empty selectedBlocks"},i);case 22:case"end":return e.stop()}}),e,this)})));return function(o){return e.apply(this,arguments)}}()},{key:"startNewThirdPartyComment",value:function(e,o){var n=this.eventCollector,r=n.collectEvent,i=n.getBlockViewByBlockId,a=e.id,c=Object(Ce.S)(),m=this.blockManager.getRecordByBlockId(a).id,l=this.thirdPartyManager.startNewComment(a,c);if(l){var d=l.quote,s=l.serviceType,u=l.serviceToken;this.addComment({quote:d,showKeyboard:!0,tempCommentId:c,serviceType:s,serviceToken:u}),this.addCommentRelation(c,[m]),this.trigger(ke.M.ADD_TEMP_COMMENT,{quote:d,commentId:c,blockIds:[a]}),this.addCommentPosition(new Set([m])),r(le.l.startNewComment,{targetBlock:i(a),tempCommentId:c,serviceType:s,serviceToken:u.slice(-12),isThirdParty:!0},o)}else r(le.l.exception,{msg:"startNewThirdPartyComment failed: no context returned",tempCommentId:c,targetBlock:i(a)},o)}},{key:"startNewDocCommentOnSingleBlock",value:function(){var e=m()(a.a.mark((function e(o,n,r){var i,c,m,l,d,s,u,h,v,f,p,g,C,y=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.eventCollector,c=i.collectEvent,m=i.getBlockViewByBlockId,l=o.id,d=o.type,s=o.selection,u=r||Object(Ce.S)(),h=this.blockManager.getBlockModelByBlockId(l),v="",f=this.blockManager.getRecordByBlockId(l).id,d!==z.j.BLOCK){e.next=15;break}if(v=Object(Ce.k)(h,this.blockManager),!Object(H.i)(h)){e.next=13;break}if(!h.isEmpty){e.next=12;break}return c(le.l.exception,{msg:"startNewDocCommentOnSingleBlock failed: comment on empty TextBlock",tempCommentId:u,targetBlock:m(l)},n),e.abrupt("return");case 12:this.transactionHelper.addLocalCommentMark(u,h.id,[0,h.zoneState.totalWidth()],"SingleBlockSelection");case 13:e.next=16;break;case 15:d===z.j.TEXT&&s&&(p=s.start,g=s.end,v=Object(L.X)(h.record.snapshot,this.blockManager.recordManager,[p,g]),this.transactionHelper.addLocalCommentMark(u,l,[p,g],"SingleTextSelection"));case 16:return C=this.addComment({quote:v,showKeyboard:!0,tempCommentId:u}),this.tempCommentIds.add(u),this.addCommentRelation(u,[f]),this.timeoutId=window.setTimeout((function(){return y.addCommentPosition(new Set([f]))}),0),this.trigger(ke.M.ADD_TEMP_COMMENT,{quote:v,commentId:u,blockIds:[l]}),c(le.l.startNewComment,{targetBlock:m(l),tempCommentId:u,isThirdParty:!1},n),e.next=24,C;case 24:case"end":return e.stop()}}),e,this)})));return function(o,n,r){return e.apply(this,arguments)}}()},{key:"startNewDocCommentOnMultiBlocks",value:function(e,o){var n=this,r=this.eventCollector,i=r.collectEvent,a=r.getBlockViewByBlockId,c=Object(Ce.S)(),m=e.filter((function(e){var o=e.id,r=n.blockManager.getBlockModelByBlockId(o);return!Object(H.i)(r)||!r.isEmpty})),l=m.map((function(e){var o=e.id;return n.blockManager.getBlockModelByBlockId(o)}));if(0!==m.length){var d="";m.forEach((function(e,o){var r=e.id,i=e.selection,a=n.blockManager.getBlockModelByBlockId(r);if(Object(H.i)(a)){var l=a.zoneState.getModelText().length-1,s=i||{start:0,end:l},u=[Math.max(0,s.start),Math.min(l,s.end)],h=u[0],v=u[1];n.transactionHelper.addLocalCommentMark(c,a.id,[h,v],"MultiBlockSelection"),d+=Object(L.X)(a.record.snapshot,n.blockManager.recordManager,[h,v]),s.end>=l&&o!==m.length-1&&(d+=" ")}else d+=Object(Ce.k)(a,n.blockManager),o!==m.length-1&&(d+=" ")})),this.addComment({quote:d,showKeyboard:!0,tempCommentId:c}),this.tempCommentIds.add(c);var s=l.reduce((function(e,o){return e.add(o.record.id),e}),new Set);this.addCommentRelation(c,Array.from(s)),this.timeoutId=window.setTimeout((function(){return n.addCommentPosition(s)}),0),this.trigger(ke.M.ADD_TEMP_COMMENT,{quote:d,commentId:c,blockIds:l.map((function(e){return e.id}))}),i(le.l.startNewComment,{targetBlocks:a(l.map((function(e){return e.id}))),tempCommentId:c,isThirdParty:!1},o)}else i(le.l.exception,{msg:"startNewDocCommentOnMultiBlocks failed: every selected block is empty",tempCommentId:c,targetBlock:a(e.map((function(e){return e.id})))},o)}},{key:"getRecordsByCommentId",value:function(e){return this.commentIdToRecordIdMap.get(e)}},{key:"getCommentsByRecordId",value:function(e){return this.recordIdToCommentIdMap.get(e)}},{key:"getBlockModelsByCommentId",value:function(e){var o=this,n=Array.from(this.commentIdToRecordIdMap.get(e)||[]);return 0===n.length?this.thirdPartyManager.getBlocksByCommentId(e):n.reduce((function(e,n){return e.concat(o.blockManager.getBlockIdsByRecordId(n))}),[]).map((function(e){return o.blockManager.getBlockModelByBlockId(e)}))}},{key:"getPositionList",value:function(){var e=this,o=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return Array.from(this.commentIdToPositionMap).map((function(n){var r=w()(n,2),i=r[0],a=r[1],c=e.getCommentByCommentId(i);return{commentId:i,context:{top:o?a.top:0,parent_type:null===c||void 0===c?void 0:c.parentType,parent_token:null===c||void 0===c?void 0:c.parentToken}}}))}},{key:"jumpToReply",value:function(e,o){this.trigger(ke.M.JUMP_REPLY,{commentId:e,replyId:o})}},{key:"activateComment",value:function(e,o,n,r,i,a){var c=this.eventCollector.collectEvent;a&&this.updateActivatedCommentToSelectionPos(a,e),this.trigger(ke.M.ACTIVATE_COMMENT,{commentId:e,replyId:o,from:n,scrollOffset:r}),c(le.l.activateComment,{commentId:e,replyId:o,scrollOffset:r,bottom:i},n)}},{key:"deactivateComment",value:function(e,o){var n=this.eventCollector.collectEvent;this.trigger(ke.M.DEACTIVATE_COMMENT),n(le.l.deactivateComment,{extraInfo:o},e)}},{key:"destroy",value:function(){this.onDestroy(),this.recordChangeTimeoutSet.forEach((function(e){window.clearTimeout(e)})),this.timeoutId&&window.clearTimeout(this.timeoutId),this.blockManager.recordManager.off(M.q.INTERCEPT_CHANGE,this.handleTransaction),q.S.off(G.r.BEFORE_UNDO_REDO,this.handleUndoRedo),this.pageEventEmitter.off(K.R.CLIENTVAR_APPLY_ALL_DONE,this.updateAllCommentPosition),this.pageEventEmitter.off(R.h,this.handleViewportLocked),this.recordIdToCommentIdMap.clear(),this.commentIdToRecordIdMap.clear(),this.commentIdToCommentMap.clear(),this.commentIdToPositionMap.clear(),this.activeCommentChangeQueue.length=0,this.activeCommentId=null}},{key:"editable",get:function(){return T.selectors.share.selectCanEditInvolvingEditMode(Q.a.getState())}}]),e}(),_e=je;n("dx_VkxF");function De(e,o){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);o&&(r=r.filter((function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable}))),n.push.apply(n,r)}return n}function Ne(e){for(var o=1;o<arguments.length;o++){var n=null!=arguments[o]?arguments[o]:{};o%2?De(Object(n),!0).forEach((function(o){d()(e,o,n[o])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):De(Object(n)).forEach((function(o){Object.defineProperty(e,o,Object.getOwnPropertyDescriptor(n,o))}))}return e}function Le(e){var o=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=b()(e);if(o){var i=b()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return k()(this,n)}}var He=function(e){C()(n,e);var o=Le(n);function n(e){var r;return u()(this,n),(r=o.call(this,e)).commentSDK=T.commentSDKHelper.getCurrentSuiteCommentSDK(),r.positionList=null,r.debouncedHandleEditorResize=Object(B.debounce)(r.handleEditorResize,100),r.detectReady=function(){r.blockManager.editorAPI.modelService.isInitialDataReady()&&r.handleBlockManagerReady()},r.bindEvents=function(){r.blockManager.editorAPI.modelService.isInitialDataReady()||r.blockManager.addListenerOnce(O.Q,r.handleBlockManagerReady)},r.handleBlockManagerReady=function(){(0,r.eventCollector.collectEvent)(le.l.blockManagerReady,{}),r.ready(),r.commentSDK.on("commentDataChange",r.handleCommentDataChange),r.blockManager.addListener(E.G,r.debouncedHandleEditorResize),r.blockManager.addListener(R.a,r.handleBufferChanged),r.blockManager.recordManager.on(M.q.CHANGE,r.handleRecordChange)},r.handleCommentDataChange=function(e,o,n){r.handleCommentChange(e.comments,o,Ne(Ne({},n),{},{type:"collaborate"===n.type?ke.K.REMOTE:ke.K.LOCAL})),n.isInit&&r.handleCommentReady()},r.handleBufferChanged=Object(B.debounce)((function(){r.updateAllCommentPosition()}),100),r.updateStoreCommentPosition=function(e,o){var n=r.eventCollector.collectEvent,i=Object(T.selectCheckCommentShown)(T.store.getState()),a=r.getPositionList(i);!Object(B.isEqual)(a,r.positionList)&&(r.positionList=a,T.store.dispatch(T.actions.comment.setCommentPositionData({commentPositions:a,rootToken:Object(T.selectCurrentSuiteToken)(T.store.getState()),rootType:Object(T.selectCurrentSuiteType)(T.store.getState())})),n(le.l.commentPositionUpdate,{updatedCommentIds:e,commentPositions:a.map((function(e){var o,n,i=null===(o=r.getPositionByCommentId(e.commentId))||void 0===o?void 0:o.blockId,a=i&&(null===(n=r.blockManager.getRecordByBlockId(i))||void 0===n?void 0:n.id)||"";return{top:e.context.top,commentId:e.commentId,blockId:a.slice(-12)}}))},o))},r.getInnerCommentModule=function(){return r.commentSDK},r.onDestroy=function(){var e;r.numberManager.destroy(),r.debouncedHandleEditorResize.cancel(),null===(e=r.commentSDK)||void 0===e||e.off("commentDataChange",r.handleCommentDataChange),r.blockManager.removeListener(O.Q,r.handleBlockManagerReady),r.blockManager.removeListener(R.a,r.handleBufferChanged),r.blockManager.removeListener(E.G,r.debouncedHandleEditorResize),r.blockManager.recordManager.off(M.q.CHANGE,r.handleRecordChange),delete window.commentModule},r.handleCommentDidAdd=function(e,o){var n=r.eventCollector.collectEvent,i=r.commentSDK.data.getComment(e,!0);if(i){var a=i.commentId,c=i.tmpCommentId;c?r.handleAddComment(c,a,ke.K.LOCAL,"SDKDidAdd"):n(le.l.exception,{msg:"handleCommentDidAdd failed: Target comment has no tmpCommentId",sourceCommentId:e})}else n(le.l.exception,{msg:"handleCommentDidAdd failed: Can't find comment entity",sourceCommentId:e})},r.handleCommentDidDelete=function(e,o){r.handleRemove(e,ke.K.LOCAL,"SDKDidDelete",o)},r.handleCommentDidResolve=function(e){r.trigger(ke.M.RESOLVE_COMMENT,{commentId:e,source:ke.K.LOCAL})},r.cancelTempComment=function(e){r.handleCancelAddComment(e,"SDKCommentDidDelete")},r.scrollToWholeComment=function(){var e=m()(a.a.mark((function e(o,n){var i,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.globalCommentLoadedPromise;case 2:return i=r.blockManager.getBlockModelByBlockId(r.blockManager.rootBlockId),c=i.children[i.children.length-1],e.abrupt("return",r.viewport.scrollToBlock(c.id,(function(){return r.highlightWholeComment(o,n,{withScroll:!0}),Promise.resolve()})));case 5:case"end":return e.stop()}}),e)})));return function(o,n){return e.apply(this,arguments)}}(),r.toggleCommentPanel=function(e){},r.setCommentable=function(e){r.commentable=e},T.commentSDKHelper.initCommentReaction(),r.bindEvents(),window.commentModule=p()(r),r}return v()(n,[{key:"ready",value:function(){this.commentSDK.hasInitCommentData&&this.handleCommentReady()}},{key:"onPositionUpdate",value:function(e,o){var n=this;this.once(ke.M.COMMENT_POSITION_CHANGE,(function(){n.updateStoreCommentPosition(e,o)}))}},{key:"highlightWholeComment",value:function(e,o,n){this.trigger(ke.M.HIGHLIGHT_WHOLE_COMMENT,{commentId:e,replyId:o,options:n})}},{key:"addComment",value:function(e){var o=e.quote,n=e.tempCommentId,r=e.serviceType,i=e.serviceToken,a=this.commentSDK.startComment({commentId:n,quote:o,isWhole:!1,parentType:r,parentToken:i});return this.commentIdToCommentMap.set(n,a),Promise.resolve()}},{key:"findComment",value:function(e){return this.commentSDK.getData().comments.find((function(o){return o.commentId===e}))}},{key:"reopenComment",value:function(e){e.finished=!1}},{key:"resolveComment",value:function(e){e.finished=!0,this.activeCommentId===e.commentId&&this.deactivateComment(le.Fr.afterResolve)}},{key:"setCommentIdToCommentMap",value:function(){var e=this;this.commentSDK.getData().comments.forEach((function(o){e.commentIdToCommentMap.set(o.commentId,o)}))}},{key:"getCommentData",value:function(){return this.commentSDK.getDataOld()}},{key:"amendQuote",value:function(e){var o=this.commentSDK.getPlugin("quote");o&&o.amendQuote(e)}},{key:"setCommentViewPortLock",value:function(e){}}]),n}(_e),Ue=He;o.default=Ue}}]);
//# sourceMappingURL=//slardar.bytedance.net/api_v2/browser/jserr/get_sourcemap?bid=docs_pc&js_filename=docx_comment_module.88048a39.chunk.js.map